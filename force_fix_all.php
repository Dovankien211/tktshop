<?php
/**
 * Force Fix t·∫•t c·∫£ links l·ªói - Kh√¥ng c·∫ßn nghƒ© g√¨
 * File: /tktshop/force_fix_all.php
 */

require_once 'config/database.php';

try {
    $pdo = new PDO("mysql:host=localhost;dbname=tktshop;charset=utf8mb4", "root", "");
} catch(PDOException $e) {
    die("L·ªói database: " . $e->getMessage());
}

$message = '';

// X·ª≠ l√Ω upload
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_FILES['image'])) {
    $productId = $_POST['product_id'];
    $file = $_FILES['image'];
    
    if ($file['error'] == 0) {
        $extension = pathinfo($file['name'], PATHINFO_EXTENSION);
        $newName = time() . '_' . $productId . '.' . $extension;
        $uploadPath = 'uploads/products/' . $newName;
        
        if (move_uploaded_file($file['tmp_name'], $uploadPath)) {
            // C·∫≠p nh·∫≠t ·∫£nh ch√≠nh
            $sql = "UPDATE san_pham_chinh SET hinh_anh_chinh = ? WHERE id = ?";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([$newName, $productId]);
            
            // T·∫°o album t·ª´ ·∫£nh v·ª´a upload
            $albumImages = [$newName];
            $sql = "UPDATE san_pham_chinh SET album_hinh_anh = ? WHERE id = ?";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([json_encode($albumImages), $productId]);
            
            $message = "‚úÖ Upload th√†nh c√¥ng cho s·∫£n ph·∫©m ID $productId";
        } else {
            $message = "‚ùå L·ªói upload!";
        }
    }
}

// X·ª≠ l√Ω force fix
if (isset($_POST['force_fix'])) {
    try {
        // FORCE FIX 1: ƒê·∫£m b·∫£o t·∫•t c·∫£ s·∫£n ph·∫©m c√≥ tags ƒë√∫ng
        
        // Reset t·∫•t c·∫£ tr∆∞·ªõc
        $pdo->exec("UPDATE san_pham_chinh SET san_pham_moi = 0, san_pham_noi_bat = 0");
        
        // Set s·∫£n ph·∫©m M·ªöI: Adidas (ID 2), Puma (ID 5) 
        $pdo->exec("UPDATE san_pham_chinh SET san_pham_moi = 1 WHERE id IN (2, 5)");
        
        // Set s·∫£n ph·∫©m N·ªîI B·∫¨T: Adidas (ID 2), Converse (ID 3), Vans (ID 4)
        $pdo->exec("UPDATE san_pham_chinh SET san_pham_noi_bat = 1 WHERE id IN (2, 3, 4)");
        
        // FORCE FIX 2: ƒê·∫£m b·∫£o danh m·ª•c ƒë√∫ng
        $pdo->exec("UPDATE san_pham_chinh SET danh_muc_id = 5 WHERE thuong_hieu = 'Adidas'"); // Gi√†y th·ªÉ thao nam
        $pdo->exec("UPDATE san_pham_chinh SET danh_muc_id = 1 WHERE thuong_hieu IN ('Converse', 'Vans', 'Puma')"); // Gi√†y th·ªÉ thao
        
        // FORCE FIX 3: T·∫°o ·∫£nh cho nh·ªØng s·∫£n ph·∫©m thi·∫øu (n·∫øu c√≥)
        $products = $pdo->query("SELECT id, ten_san_pham, hinh_anh_chinh, album_hinh_anh FROM san_pham_chinh")->fetchAll(PDO::FETCH_ASSOC);
        $fixedCount = 0;
        
        foreach ($products as $product) {
            $needsFix = false;
            
            // Ki·ªÉm tra ·∫£nh ch√≠nh
            if (empty($product['hinh_anh_chinh']) || !file_exists('uploads/products/' . $product['hinh_anh_chinh'])) {
                $needsFix = true;
            }
            
            // Ki·ªÉm tra album
            $hasValidAlbum = false;
            if (!empty($product['album_hinh_anh'])) {
                $albumImages = json_decode($product['album_hinh_anh'], true);
                if ($albumImages) {
                    foreach ($albumImages as $img) {
                        if (file_exists('uploads/products/' . $img)) {
                            $hasValidAlbum = true;
                            break;
                        }
                    }
                }
            }
            
            if (!$hasValidAlbum) {
                $needsFix = true;
            }
            
            // T·∫°o ·∫£nh placeholder n·∫øu c·∫ßn
            if ($needsFix) {
                $placeholderName = "temp_product_{$product['id']}.png";
                $placeholderPath = "uploads/products/$placeholderName";
                
                if (createPlaceholder($placeholderPath, $product['ten_san_pham'])) {
                    // C·∫≠p nh·∫≠t ·∫£nh ch√≠nh
                    $sql = "UPDATE san_pham_chinh SET hinh_anh_chinh = ? WHERE id = ?";
                    $stmt = $pdo->prepare($sql);
                    $stmt->execute([$placeholderName, $product['id']]);
                    
                    // C·∫≠p nh·∫≠t album
                    $sql = "UPDATE san_pham_chinh SET album_hinh_anh = ? WHERE id = ?";
                    $stmt = $pdo->prepare($sql);
                    $stmt->execute([json_encode([$placeholderName]), $product['id']]);
                    
                    $fixedCount++;
                }
            }
        }
        
        $message = "‚úÖ FORCE FIX th√†nh c√¥ng! ƒê√£ s·ª≠a tags, danh m·ª•c v√† t·∫°o $fixedCount ·∫£nh placeholder!";
        
    } catch (Exception $e) {
        $message = "‚ùå L·ªói: " . $e->getMessage();
    }
}

// Function t·∫°o ·∫£nh placeholder ƒë∆°n gi·∫£n
function createPlaceholder($filePath, $productName) {
    if (!extension_loaded('gd')) {
        return false;
    }
    
    $width = 400;
    $height = 400;
    
    $image = imagecreate($width, $height);
    $bgColor = imagecolorallocate($image, 240, 240, 240);
    $textColor = imagecolorallocate($image, 100, 100, 100);
    
    // V·∫Ω text
    $text = strtoupper(substr($productName, 0, 15));
    imagestring($image, 5, 50, $height/2 - 20, $text, $textColor);
    imagestring($image, 3, 50, $height/2 + 20, date('Y-m-d'), $textColor);
    
    $result = imagepng($image, $filePath);
    imagedestroy($image);
    
    return $result;
}

// L·∫•y t·∫•t c·∫£ s·∫£n ph·∫©m
$allProducts = $pdo->query("SELECT * FROM san_pham_chinh ORDER BY id")->fetchAll(PDO::FETCH_ASSOC);

// Ph√¢n t√≠ch v·∫•n ƒë·ªÅ
$issues = [];
foreach ($allProducts as $product) {
    $productIssues = [];
    
    // Ki·ªÉm tra ·∫£nh
    if (empty($product['hinh_anh_chinh']) || !file_exists('uploads/products/' . $product['hinh_anh_chinh'])) {
        $productIssues[] = 'Thi·∫øu ·∫£nh ch√≠nh';
    }
    
    $hasValidAlbum = false;
    if (!empty($product['album_hinh_anh'])) {
        $albumImages = json_decode($product['album_hinh_anh'], true);
        if ($albumImages) {
            foreach ($albumImages as $img) {
                if (file_exists('uploads/products/' . $img)) {
                    $hasValidAlbum = true;
                    break;
                }
            }
        }
    }
    if (!$hasValidAlbum) {
        $productIssues[] = 'Thi·∫øu album';
    }
    
    if (!empty($productIssues)) {
        $issues[] = [
            'product' => $product,
            'issues' => $productIssues
        ];
    }
}

?>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Force Fix T·∫•t C·∫£ Links L·ªói</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .container { max-width: 1000px; margin: 0 auto; }
        .big-title { font-size: 2.5em; font-weight: bold; text-align: center; margin: 20px 0; color: #dc3545; }
        .force-fix-btn { background: #dc3545; color: white; padding: 20px 40px; border: none; border-radius: 8px; cursor: pointer; font-size: 20px; font-weight: bold; margin: 20px; }
        .force-fix-btn:hover { background: #c82333; transform: scale(1.05); }
        .message { padding: 20px; margin: 20px 0; border-radius: 8px; background: #d4edda; color: #155724; font-size: 18px; text-align: center; }
        .links-section { background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border: 2px solid #ffc107; }
        .test-link { background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; margin: 5px; display: inline-block; }
        .test-link:hover { background: #0056b3; text-decoration: none; color: white; }
        .product-item { border: 2px solid #dc3545; margin: 15px 0; padding: 15px; border-radius: 8px; background: #fff5f5; }
        .upload-form { background: #e3f2fd; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .btn { background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #218838; }
        input[type="file"] { width: 100%; padding: 8px; margin: 10px 0; }
        .stats { background: white; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0; border: 1px solid #dee2e6; }
    </style>
</head>
<body>

<div class="container">
    <div class="big-title">üî• FORCE FIX T·∫§T C·∫¢ LINKS L·ªñI</div>
    
    <?php if ($message): ?>
    <div class="message"><?= $message ?></div>
    <?php endif; ?>
    
    <div class="stats">
        <h3>üìä T√åNH H√åNH HI·ªÜN T·∫†I</h3>
        <p><strong>T·ªïng s·∫£n ph·∫©m:</strong> <?= count($allProducts) ?></p>
        <p><strong>S·∫£n ph·∫©m c√≥ v·∫•n ƒë·ªÅ:</strong> <?= count($issues) ?></p>
        <p><strong>S·∫£n ph·∫©m OK:</strong> <?= count($allProducts) - count($issues) ?></p>
    </div>
    
    <!-- FORCE FIX BUTTON -->
    <div style="text-align: center; margin: 30px 0; padding: 30px; background: #fff; border-radius: 8px; border: 3px solid #dc3545;">
        <h2 style="color: #dc3545; margin: 0 0 20px 0;">‚ö° FORCE FIX T·∫§T C·∫¢</h2>
        <p style="font-size: 16px; margin: 10px 0;">
            S·∫Ω t·ª± ƒë·ªông fix:<br>
            ‚úÖ Set s·∫£n ph·∫©m m·ªõi/n·ªïi b·∫≠t<br>
            ‚úÖ S·ª≠a danh m·ª•c<br>
            ‚úÖ T·∫°o ·∫£nh placeholder cho s·∫£n ph·∫©m thi·∫øu<br>
        </p>
        
        <form method="POST" style="display: inline;">
            <button type="submit" name="force_fix" class="force-fix-btn" 
                    onclick="return confirm('FORCE FIX t·∫•t c·∫£? H√†nh ƒë·ªông n√†y s·∫Ω thay ƒë·ªïi database!')">
                üöÄ FORCE FIX NGAY L·∫¨P T·ª®C
            </button>
        </form>
    </div>
    
    <!-- TEST LINKS -->
    <div class="links-section">
        <h3 style="margin: 0 0 15px 0; color: #856404;">üîó TEST C√ÅC LINK SAU KHI FIX:</h3>
        <a href="customer/products.php?new=1" target="_blank" class="test-link">üÜï S·∫£n ph·∫©m m·ªõi</a>
        <a href="customer/products.php?new=1&category=1" target="_blank" class="test-link">üÜï M·ªõi + Danh m·ª•c 1</a>
        <a href="customer/products.php?new=1&category=5" target="_blank" class="test-link">üÜï M·ªõi + Danh m·ª•c 5</a>
        <a href="customer/products.php?featured=1" target="_blank" class="test-link">‚≠ê S·∫£n ph·∫©m n·ªïi b·∫≠t</a>
        <a href="customer/products.php?brand=Adidas" target="_blank" class="test-link">üëü Adidas</a>
        <a href="customer/products.php?brand=Vans" target="_blank" class="test-link">üõπ Vans</a>
        <a href="customer/products.php?brand=Puma" target="_blank" class="test-link">üêæ Puma</a>
    </div>
    
    <?php if (!empty($issues)): ?>
    <!-- S·∫¢N PH·∫®M C·∫¶N UPLOAD ·∫¢NH -->
    <h2 style="color: #dc3545;">üì§ HO·∫∂C UPLOAD ·∫¢NH TH·∫¨T T·ª™ M√ÅY C·ª¶A B·∫†N:</h2>
    
    <?php foreach ($issues as $issue): 
        $product = $issue['product'];
    ?>
    <div class="product-item">
        <h3 style="margin: 0 0 10px 0;">
            üè∑Ô∏è <?= htmlspecialchars($product['ten_san_pham']) ?> (ID: <?= $product['id'] ?>)
        </h3>
        <p><strong>Th∆∞∆°ng hi·ªáu:</strong> <?= $product['thuong_hieu'] ?> | 
           <strong>V·∫•n ƒë·ªÅ:</strong> <span style="color: #dc3545;"><?= implode(', ', $issue['issues']) ?></span></p>
        
        <div class="upload-form">
            <form method="POST" enctype="multipart/form-data">
                <input type="hidden" name="product_id" value="<?= $product['id'] ?>">
                
                <label style="font-weight: bold; display: block;">üì∑ Ch·ªçn ·∫£nh t·ª´ m√°y:</label>
                <input type="file" name="image" accept="image/*" required>
                
                <button type="submit" class="btn">üì§ UPLOAD ·∫¢NH CHO S·∫¢N PH·∫®M N√ÄY</button>
            </form>
        </div>
    </div>
    <?php endforeach; ?>
    
    <?php endif; ?>
    
    <div style="text-align: center; margin: 40px 0; padding: 20px; background: #e9ecef; border-radius: 8px;">
        <h3>üéØ H∆Ø·ªöNG D·∫™N:</h3>
        <ol style="text-align: left; display: inline-block;">
            <li><strong>Click "FORCE FIX NGAY L·∫¨P T·ª®C"</strong> ƒë·ªÉ t·ª± ƒë·ªông fix t·∫•t c·∫£</li>
            <li><strong>Ho·∫∑c upload ·∫£nh th·∫≠t</strong> t·ª´ m√°y c·ªßa b·∫°n cho t·ª´ng s·∫£n ph·∫©m</li>
            <li><strong>Test c√°c link</strong> ·ªü ph·∫ßn "TEST C√ÅC LINK" ƒë·ªÉ ki·ªÉm tra</li>
        </ol>
    </div>
</div>

</body>
</html>